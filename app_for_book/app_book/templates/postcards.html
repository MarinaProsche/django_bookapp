<!DOCTYPE html>
{% include 'index.html' %}
{% load extra_filters %}
<html>

<head>
    <title>Стена с открытками</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

<body>
    <div class="container py-3">
        <h1 class="text-center no-margin-bottom">Стена с открытками</h1>
        <p class="regular-text" style="text-align: left; padding-bottom: 10px;">
            <i>* нажмите, чтобы открыть</i>
        </p>

        <div id="postcards-container" class="row row-cols-2 row-cols-lg-3 g-2">
            {% for postcard in postcards %}
            {% include 'partials/one_of_postcards.html' %}
            {% endfor %}
        </div>

        <!-- scroll -->
        <div id="load-more-trigger" style="height: 1px;"></div>
    </div>

    <script>
        let currentPage = {{ postcards.number }};  // текущая страница
        let totalPages = {{ postcards.paginator.num_pages }};
        let isLoading = false;

        const loadMoreTrigger = document.getElementById('load-more-trigger');
        const container = document.getElementById('postcards-container');

        const observer = new IntersectionObserver(async (entries) => {
            if (entries[0].isIntersecting && !isLoading && currentPage < totalPages) {
                isLoading = true;
                currentPage++;

                try {
                    const response = await fetch(`?page=${currentPage}`, {
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });
                    const html = await response.text();
                    container.insertAdjacentHTML('beforeend', html);
                } catch (e) {
                    console.error('Ошибка загрузки:', e);
                } finally {
                    isLoading = false;
                }
            }
        });

        observer.observe(loadMoreTrigger);
    </script>
</body>

</html>
